var brfPhoneGapApp=angular.module("brfPhoneGapApp",["ngRoute"]),db,app={initialize:function(){this.bindEvents(),db=window.openDatabase("BRF","1.0","BRF",2e5)},bindEvents:function(){document.addEventListener("deviceready",this.onDeviceReady,!1)},onDeviceReady:function(){app.receivedEvent("deviceready")},receivedEvent:function(e){var n=document.getElementById(e),t=n.querySelector(".listening"),o=n.querySelector(".received");t.setAttribute("style","display:none;"),o.setAttribute("style","display:block;"),console.log("Received Event: "+e)}},app={initialize:function(){this.bindEvents()},bindEvents:function(){document.addEventListener("deviceready",this.onDeviceReady,!1)},onDeviceReady:function(){app.receivedEvent("deviceready")},receivedEvent:function(e){var n=document.getElementById(e),t=n.querySelector(".listening"),o=n.querySelector(".received");t.setAttribute("style","display:none;"),o.setAttribute("style","display:block;"),console.log("Received Event: "+e)}},BrfNameSpace=BrfNameSpace||{};BrfNameSpace.Session=function(){function e(){var e="brf-session";return{set:function(n){window.localStorage.setItem(e,JSON.stringify(n))},get:function(){var n=null;try{n=JSON.parse(window.localStorage.getItem(e))}catch(t){}return n}}}var n;return{getInstance:function(){return n||(n=e()),n}}}(),brfPhoneGapApp.config(["$routeProvider",function(e){e.when("/Main",{templateUrl:"app/views/main.html",controller:"mainController",access:{isFreeAccess:!1,audit:!1}}).when("/Dashboard",{templateUrl:"app/views/dashboard.html",controller:"dashboardController",access:{isFreeAccess:!1,audit:!1}}).when("/Welcome",{templateUrl:"app/views/welcome.html",controller:"welcomeController",access:{isFreeAccess:!1,audit:!1}}).when("/Channel",{templateUrl:"app/views/channels.html",controller:"channelsController",access:{isFreeAccess:!1,audit:!1}}).when("/Channel/:channelId/Pdv",{templateUrl:"app/views/form.html",controller:"formController",access:{isFreeAccess:!1,audit:!1}}).when("/Channel/:channelId/AddPdv",{templateUrl:"app/views/new-pdv.html",controller:"pdvController",access:{isFreeAccess:!1,audit:!1}}).when("/Channel/:channelId/Pdv/:pdvId/Seller",{templateUrl:"app/views/search.html",controller:"searchController",access:{isFreeAccess:!1,audit:!1}}).when("/",{templateUrl:"app/views/login.html",controller:"loginController",access:{isFreeAccess:!0}}).when("/Synchronizer",{templateUrl:"app/views/synchronizer.html",controller:"synchronizerController",access:{isFreeAccess:!1,audit:!1}}).when("/DoSynchronization",{templateUrl:"app/views/doSynchronization.html",controller:"doSynchronizationController",access:{isFreeAccess:!1,audit:!1}}).when("/SyncOk",{templateUrl:"app/views/syncOk.html",controller:"syncOkController",access:{isFreeAccess:!1,audit:!1}}).when("/SyncNok",{templateUrl:"app/views/syncNok.html",controller:"syncNokController",access:{isFreeAccess:!1,audit:!1}}).when("/Channel/:channelId/Pdv/:pdvId/Seller/:sellerId/observaciones/:default?",{templateUrl:"app/views/observations.html",controller:"observationsController",access:{isFreeAccess:!1,audit:!0}}).when("/Channel/:channelId/Pdv/:pdvId/Seller/:sellerId/no_brf/:default?",{templateUrl:"app/views/noBrf.html",controller:"noBrfController",access:{isFreeAccess:!1,audit:!0}}).when("/Channel/:channelId/Pdv/:pdvId/Seller/:sellerId/Module/:moduleId",{templateUrl:"app/views/questions.html",controller:"questionsController",access:{isFreeAccess:!1,audit:!0}}).when("/Channel/:channelId/Pdv/:pdvId/Seller/:sellerId/Module/:moduleId/Category/:categoryId/CategoryType/:categoryType",{templateUrl:"app/views/questions.html",controller:"questionsController",access:{isFreeAccess:!1,audit:!0}}).when("/Channel/:channelId/Pdv/:pdvId/Seller/:sellerId/:slug/:default?",{templateUrl:"app/views/categorySearch.html",controller:"categoryController",access:{isFreeAccess:!1,audit:!0}}).otherwise({redirectTo:"/"})}]).run(function(e,n,t,o,r){r.init(),e.$on("$viewContentLoaded",function(e){$(".collapsible").collapsible(),$("select").material_select()}),e.$on("$routeChangeStart",function(e,r){void 0!=r.access&&(r.access.isFreeAccess||t.authenticated()||n.path("/")),void 0!=r.access?!r.access.audit&&o.getAuditMode()&&n.path("/Channel/"+o.getAuditChannel()+"/Pdv/"+o.getAuditPdv()+"/Seller/"+o.getAuditSeller()+"/coaching_sp/defaultModule"):n.path("/Main")})}),brfPhoneGapApp.controller("categoryController",["$scope","$routeParams","Category","$rootScope","Module","$location",function(e,n,t,o,r,a){e.routeParams=n,e.currentModule,"defaultModule"===e.routeParams["default"]&&(console.log("defaultModuleLoaded"),o.$emit("defaultModuleLoaded")),r.getModuleBySlug(e.routeParams.slug).then(function(n){e.currentModule=n,t.getCategories(n.categoryType,e.routeParams.channelId).then(function(t){t.length>0?e.categories=t:a.path("/Channel/"+e.routeParams.channelId+"/Pdv/"+e.routeParams.pdvId+"/Seller/"+e.routeParams.sellerId+"/Module/"+n.moduleId)})})}]),brfPhoneGapApp.controller("channelsController",["$scope","$route","$routeParams","Channel",function(e,n,t,o){o.getChannels().then(function(n){e.channels=n})}]),brfPhoneGapApp.controller("coachingController",["$scope","$route","$routeParams","Question","Survey","Module","$rootScope",function(e,n,t,o,r,a,i){e.routeParams=t,a.getModuleByName("Coaching Supervisor").then(function(n){console.log("Emit Default Module Loaded Event"),i.$emit("defaultModuleLoaded"),r.getPendingSurvey().then(function(t){void 0!==t?o.getQuestions(n.moduleId,t.id,void 0,n.categoryType).then(function(n){e.questions=n}):o.getQuestions(n.moduleId,0,void 0,n.categoryType).then(function(n){e.questions=n})})})}]),brfPhoneGapApp.controller("dashboardController",function(e,n){e.visitedPDVs=12,e.obtainedCompliance="89%",e.coachingPoints={percentage:90,points:[{name:"Punto #1",percentage:90},{name:"Punto #2",percentage:90},{name:"Punto #3",percentage:90},{name:"Punto #4",percentage:90}]},e.executionPoints={percentage:72,points:[{name:"Punto #1",percentage:90},{name:"Punto #2",percentage:90},{name:"Punto #3",percentage:90},{name:"Punto #4",percentage:90}]},e.dashboardOpts={availableOptions:[{id:"0",name:"HOY"},{id:"1",name:"ESTA SEMANA"},{id:"2",name:"MES ACTUAL"},{id:"3",name:"ULTIMOS 30 DIAS"},{id:"4",name:"TRIMESTRE"}],selectedOption:{id:"0",name:"HOY"}}}),brfPhoneGapApp.controller("doSynchronizationController",function(e,n,t,o,r,a,i,u,s,c,l){e.syncChannels=0,e.syncCustomers=0,e.syncCustomersType=0,e.syncSellers=0,e.syncModules=0,e.syncCategories=0,e.syncCategoriesImg=0,e.syncQuestions=0,l.dropAll().then(function(){l.init();var n=t.defer();return e.syncChannels=1,a.synchronizeChannels().then(function(o){var r=[];angular.forEach(o.data.channels,function(e,n){r.push(a.setChannel(e.id,e.name))}),t.all(r).then(function(){e.syncChannels=2,n.resolve()})})["catch"](function(e){n.reject(e)}),n.promise}).then(function(){var n=t.defer();return e.syncCustomers=1,i.synchronizeCustomers().then(function(o){var r=[];angular.forEach(o.data.customers,function(e,n){r.push(i.setCustomer(e.id,e.company_name,e.cuit,e.address,e.type_pdv))}),t.all(r).then(function(){e.syncCustomers=2,n.resolve()})})["catch"](function(e){n.reject(e)}),n.promise}).then(function(){var n=t.defer();return e.syncCustomersType=1,i.synchronizeCustomerTypes().then(function(o){var r=[];angular.forEach(o.data.customer_types,function(e,n){r.push(i.setCustomerType(e.id,e.name))}),t.all(r).then(function(){e.syncCustomersType=2,n.resolve()})})["catch"](function(e){n.reject(e)}),n.promise}).then(function(){var n=t.defer();return e.syncSellers=1,c.synchronizeSellers().then(function(o){var r=[];angular.forEach(o.data.sellers,function(e,n){r.push(c.setSeller(e.id,e.name))}),t.all(r).then(function(){e.syncSellers=2,n.resolve()})})["catch"](function(e){n.reject(e)}),n.promise}).then(function(){var n=t.defer();return e.syncModules=1,u.synchronizeModules().then(function(o){var r=[];angular.forEach(o.data.modules,function(e,n){var t=e.id;r.push(u.setModule(e.id,e.behavior,e.mod_name,e.category_type,e.style.color,e.style.icon,e.slug)),angular.forEach(e.ids_channels,function(e,n){r.push(u.setModuleChannels(t,e))}),angular.forEach(e.ids_user_roles,function(e,n){r.push(u.setModuleRoles(t,e))})}),t.all(r).then(function(){e.syncModules=2,n.resolve()})})["catch"](function(e){n.reject(e)}),n.promise}).then(function(n){var o=t.defer();return e.syncCategories=1,r.synchronizeCategories().then(function(n){var a=[];angular.forEach(n.data.categories,function(e,n){var t=e.id;a.push(r.setCategory(e.id,e.type,e.name)),angular.forEach(e.id_channels,function(e,n){a.push(r.setCategoryChannel(t,e))})}),t.all(a).then(function(){e.syncCategories=2,o.resolve()})})["catch"](function(e){o.reject(e)}),o.promise}).then(function(){var n=t.defer();return e.syncCategoriesImg=1,r.synchronizeCategoryImages().then(function(o){var a=[];angular.forEach(o.data.categories_images,function(e,n){a.push(r.setCategoryImage(e.id,e.id_mod,e.id_cat,e.image,e.icon))}),t.all(a).then(function(){e.syncCategoriesImg=2,n.resolve()})})["catch"](function(e){n.reject(e)}),n.promise}).then(function(){var n=t.defer();return e.syncQuestions=1,s.synchronizeQuestions().then(function(r){var a=[];angular.forEach(r.data.questions,function(e,n){var t=e.id;a.push(s.setQuestion({questionId:e.id,categoryId:e.id_category,render:e.render,answer:e.answer,title:e.title,data:e.data,helper:e.helper,big:e.big,thumb:e.thumb,questionModuleId:e.id_question_mod,config:"object"==typeof e.config?JSON.stringify(e.config):e.config,styling:"object"==typeof e.styling?JSON.stringify(e.styling):e.styling})),angular.forEach(e.pdv_filter,function(e,n){a.push(s.setQuestionPdv(t,e))})}),t.all(a).then(function(){e.syncQuestions=2,n.resolve(),o.path("/SyncOk")})})["catch"](function(e){n.reject(e)}),n.promise})["catch"](function(e){console.log(e),o.path("/SyncNok")})}),brfPhoneGapApp.controller("executionController",["$scope","$route","$routeParams","Question","Module","Survey",function(e,n,t,o,r,a){r.getModuleByName("Ejecuci√≥n PDV").then(function(n){a.getPendingSurvey().then(function(r){void 0!==t.categoryId?(console.log("fu1"),o.getQuestions(n.moduleId,r.id,t.categoryId).then(function(n){e.questions=n})):o.getQuestions(n.moduleId,r.id,void 0,n.categoryType).then(function(n){e.questions=n})})})}]),brfPhoneGapApp.controller("formController",["$scope","$route","$routeParams","Customer",function(e,n,t,o){e.channelId=t.channelId,o.getCustomers().then(function(n){e.customers=n})}]),brfPhoneGapApp.controller("mainController",function(e,n){});var BrfNameSpace=BrfNameSpace||{};brfPhoneGapApp.controller("loginController",["$scope","$route","$location","Login","Survey","$routeParams","$rootScope","Module",function(e,n,t,o,r,a,i,u){e.username,e.password,e.routeParams=a,o.authenticated()&&t.path("/Main"),e.loadModules=function(){u.getModules(r.getAuditChannel(),o.getToken().id_role).then(function(n){e.modules=n})},i.$on("defaultModuleLoaded",function(n,t){r.getPendingSurvey().then(function(n){void 0===n?r.setSurvey((new Date).getTime().toString()).then(function(){r.enableAuditMode(a.channelId,a.pdvId,a.sellerId),e.loadModules()}):e.loadModules()})}),e.login=function(n){o.validateUser(e.username,e.password).then(function(n){"string"==typeof n.data?"false"===n.data.trim()&&(e.username="",e.password=""):"object"==typeof n.data&&(o.authenticate(n.data),t.path("/Main"))})},e.logout=function(){o.authenticate(void 0),t.path("/")},e.authenticated=function(){return o.authenticated()},e.isAuditModeEnabled=function(){return r.getAuditMode()},e.getUserName=function(){if(!o.authenticated())return"";var e=o.getToken();return e.name}}]),brfPhoneGapApp.controller("noBrfController",["$scope","Survey",function(e,n){n.getPendingSurvey().then(function(t){n.getNoBrf(t.id).then(function(n){void 0===n?e.noBrfStatus=!1:e.noBrfStatus="true"===n.noBrf})}),e.noBrfChanged=function(){n.getPendingSurvey().then(function(t){n.setNoBrf(t.id,e.noBrfStatus).then(function(){})})}}]),brfPhoneGapApp.controller("observationsController",["$scope","Survey",function(e,n){n.getPendingSurvey().then(function(t){n.getObservations(t.id).then(function(n){void 0===n?e.observations="":e.observations=n.observations})}),e.observations,e.observationsChanged=function(){n.getPendingSurvey().then(function(t){n.setObservations(t.id,e.observations).then(function(){})})}}]),brfPhoneGapApp.controller("pdvController",["$scope","$route","$location","$routeParams","Customer",function(e,n,t,o,r){r.getCustomerTypes().then(function(n){e.customerTypes=n,e.selectedCustomerType=e.customerTypes[0]}),e.companyName,e.identifier,e.address,e.addPdv=function(n){r.setCustomer(0,e.companyName,e.identifier,e.address,e.selectedCustomerType.id).then(function(){t.path("Channel/"+o.channelId+"/Pdv/0/Seller")})}}]),brfPhoneGapApp.controller("pricesController",["$scope","$routeParams","Question","Module","Survey",function(e,n,t,o,r){o.getModuleByName("Toma de Precios").then(function(o){r.getPendingSurvey().then(function(r){t.getQuestions(o.moduleId,r.id,n.categoryId,o.categoryType).then(function(n){e.questions=n})})})}]),brfPhoneGapApp.controller("questionsController",["$scope","Survey","$routeParams","Question","Category","Module",function(e,n,t,o,r,a){e.binaryAction=function(e,t){var o={value:t};n.getPendingSurvey().then(function(t){n.setQuestionAnswer(t.id,e.id,JSON.stringify(o)).then(function(){e.JSONData=o})})},e.undoBinaryAction=function(e){n.getPendingSurvey().then(function(t){n.deleteQuestionAnswer(t.id,e.id).then(function(){e.JSONData=void 0})})},e.openAction=function(e){n.getPendingSurvey().then(function(t){n.setQuestionAnswer(t.id,e.id,JSON.stringify(e.JSONData)).then(function(){})})},e.priceAction=function(e){n.getPendingSurvey().then(function(t){n.setQuestionAnswer(t.id,e.id,JSON.stringify(e.JSONData)).then(function(){})})},e.multipleAction=function(e){n.getPendingSurvey().then(function(t){n.setQuestionAnswer(t.id,e.id,JSON.stringify(e.config.answer_config.selected)).then(function(){})})},e.range=function(e){return new Array(e)},void 0!==t.categoryId?n.getPendingSurvey().then(function(n){r.getCategoryById(t.categoryId).then(function(n){e.currentCategory=n}),a.getModuleById(t.moduleId).then(function(n){e.currentModule=n}),o.getQuestions(t.moduleId,n.id,t.categoryId,t.categoryType).then(function(n){e.questions=n})}):a.getModuleById(t.moduleId).then(function(r){e.currentModule=r,n.getPendingSurvey().then(function(n){void 0!==n?o.getQuestions(r.moduleId,n.id,void 0,r.categoryType).then(function(n){e.questions=n}):o.getQuestions(t.moduleId,0,void 0,r.categoryType).then(function(n){e.questions=n})})})}]),brfPhoneGapApp.controller("searchController",["$scope","$route","$routeParams","Seller","Module","Login",function(e,n,t,o,r,a){e.pdvId=t.pdvId,e.channelId=t.channelId,e.defaultModuleSlug,r.getDefaultModules(e.channelId,a.getToken().id_role).then(function(n){e.defaultModuleSlug=n.slug}),o.getSellers().then(function(n){e.sellers=n})}]),brfPhoneGapApp.controller("surveyController",["$scope","$route","$location","Survey",function(e,n,t,o){e.closeAudit=function(){o.disableAuditMode(),o.closeSurvey().then(function(){t.path("/Welcome")})}}]),brfPhoneGapApp.controller("synchronizerController",["$scope",function(e){}]),brfPhoneGapApp.controller("syncNokController",function(e){}),brfPhoneGapApp.controller("syncOkController",function(e){}),brfPhoneGapApp.controller("welcomeController",function(e){}),brfPhoneGapApp.directive("questions",function(){return{restrict:"E",scope:{content:"="},templateUrl:"app/partials/questions.html",replace:!0}}),brfPhoneGapApp.factory("Category",["$http","Database",function(e,n){var t=this;return t.synchronizeCategories=function(){return e.get("http://ws.brf-horizonte.com/get/categories/?token=560a100abad225d5afdf4fc6e5334917")},t.synchronizeCategoryImages=function(){return e.get("http://ws.brf-horizonte.com/get/categories/images/?token=560a100abad225d5afdf4fc6e5334917")},t.setCategory=function(e,t,o){return n.query("INSERT INTO Category(categoryId, type, name) VALUES(?, ?, ?)",[e,t,o]).then(function(e){return!0})},t.setCategoryChannel=function(e,t){return n.query("INSERT INTO CategoryChannels(categoryId, channelId) VALUES(?, ?)",[e,t]).then(function(e){return!0})},t.setCategoryImage=function(e,t,o,r,a){return n.query("INSERT INTO CategoryImage(imageId, idMod, idCat, image, icon) VALUES(?, ?, ?, ?, ?)",[e,t,o,r,a]).then(function(e){return!0})},t.getCategories=function(e,t){var o="SELECT * FROM Category cat INNER JOIN CategoryChannels catchan ON catchan.categoryId = cat.categoryId WHERE cat.type = ? AND catchan.channelId = ?";return n.query(o,[e,t]).then(function(e){return n.fetchAll(e)})},t.getCategoryById=function(e){return n.query("SELECT * FROM Category WHERE CategoryId = ?",[e]).then(function(e){return n.fetch(e)})},t}]),brfPhoneGapApp.factory("Channel",["$http","Database",function(e,n){var t=this;return t.synchronizeChannels=function(){return e.get("http://ws.brf-horizonte.com/get/channels/?token=560a100abad225d5afdf4fc6e5334917")},t.setChannel=function(e,t){return n.query("INSERT INTO Channel(id, name) VALUES(?, ?)",[e,t]).then(function(e){return!0})},t.getChannels=function(){return n.query("Select id, name From Channel").then(function(e){return n.fetchAll(e)})},t}]),brfPhoneGapApp.factory("Config",function(){var e=this;return e.DB_CONFIG={name:"BRF",tables:[{name:"Category",columns:[{name:"id",type:"integer primary key"},{name:"categoryId",type:"integer"},{name:"type",type:"integer"},{name:"name",type:"text"}]},{name:"CategoryChannels",columns:[{name:"id",type:"integer primary key"},{name:"categoryId",type:"integer"},{name:"channelId",type:"integer"}]},{name:"CategoryImage",columns:[{name:"id",type:"integer primary key"},{name:"imageId",type:"integer"},{name:"idMod",type:"integer"},{name:"idCat",type:"integer"},{name:"image",type:"text"},{name:"icon",type:"text"}]},{name:"Channel",columns:[{name:"id",type:"integer primary key"},{name:"name",type:"text"}]},{name:"Customer",columns:[{name:"id",type:"integer primary key"},{name:"customerId",type:"integer"},{name:"companyName",type:"text"},{name:"cuit",type:"text"},{name:"address",type:"text"},{name:"pdvType",type:"integer"}]},{name:"CustomerType",columns:[{name:"id",type:"integer primary key"},{name:"name",type:"text"}]},{name:"Module",columns:[{name:"id",type:"integer primary key"},{name:"moduleId",type:"integer"},{name:"behavior",type:"text"},{name:"modName",type:"text"},{name:"categoryType",type:"integer"},{name:"color",type:"text"},{name:"icon",type:"text"},{name:"slug",type:"text"}]},{name:"ModuleChannels",columns:[{name:"id",type:"integer primary key"},{name:"moduleId",type:"integer"},{name:"channelId",type:"integer"}]},{name:"ModuleUserRoles",columns:[{name:"id",type:"integer primary key"},{name:"moduleId",type:"integer"},{name:"roleId",type:"integer"}]},{name:"Question",columns:[{name:"id",type:"integer primary key"},{name:"questionId",type:"integer"},{name:"categoryId",type:"integer"},{name:"render",type:"text"},{name:"answer",type:"text"},{name:"title",type:"text"},{name:"data",type:"text"},{name:"helper",type:"text"},{name:"big",type:"text"},{name:"thumb",type:"text"},{name:"questionModuleId",type:"integer"},{name:"config",type:"text"},{name:"styling",type:"text"}]},{name:"QuestionPdv",columns:[{name:"id",type:"integer primary key"},{name:"questionId",type:"integer"},{name:"pdvId",type:"integer"}]},{name:"Seller",columns:[{name:"id",type:"integer primary key"},{name:"name",type:"name"}]},{name:"Survey",columns:[{name:"id",type:"integer primary key"},{name:"survey",type:"text"},{name:"syncStatus",type:"integer"}]},{name:"SurveyNoBrfResults",columns:[{name:"id",type:"integer primary key"},{name:"surveyId",type:"integer"},{name:"noBrf",type:"boolean"}]},{name:"SurveyObservationResults",columns:[{name:"id",type:"integer primary key"},{name:"surveyId",type:"integer"},{name:"observations",type:"text"}]},{name:"SurveyQuestionsResults",columns:[{name:"id",type:"integer primary key"},{name:"surveyId",type:"integer"},{name:"questionId",type:"integer"},{name:"JSONData",type:"text"}]}]},e}),brfPhoneGapApp.factory("Customer",["$http","Database",function(e,n){var t=this;return t.synchronizeCustomers=function(){return e.get("http://ws.brf-horizonte.com/get/customers/?token=560a100abad225d5afdf4fc6e5334917")},t.synchronizeCustomerTypes=function(n){return e.get("http://ws.brf-horizonte.com/get/customers/type/?token=560a100abad225d5afdf4fc6e5334917")},t.setCustomer=function(e,t,o,r,a){return n.query("INSERT INTO Customer(customerId, companyName, cuit, address, pdvType) VALUES(?, ?, ?, ?, ?)",[e,t,o,r,a]).then(function(e){return!0})},t.setCustomerType=function(e,t){return n.query("INSERT INTO CustomerType(id, name) VALUES(?, ?)",[e,t]).then(function(e){return!0})},t.getCustomers=function(){return n.query("SELECT customerId, address FROM Customer LIMIT 0, 10").then(function(e){return n.fetchAll(e)})},t.getCustomerTypes=function(){return n.query("SELECT id, name FROM CustomerType").then(function(e){return n.fetchAll(e)})},t}]),brfPhoneGapApp.factory("Database",["$q","Config",function(e,n){var t=this;return t.db=null,t.init=function(){t.db=window.openDatabase(n.DB_CONFIG.name,"1.0","database",2e3),angular.forEach(n.DB_CONFIG.tables,function(e){var n=[];angular.forEach(e.columns,function(e){n.push(e.name+" "+e.type)});var o="CREATE TABLE IF NOT EXISTS "+e.name+" ("+n.join(",")+")";t.query(o),console.log("Table "+e.name+" initialized")})},t.dropAll=function(){var o=e.defer(),r=[];return angular.forEach(n.DB_CONFIG.tables,function(n){var a="DROP TABLE IF EXISTS "+n.name;r.push(t.query(a)),console.log("Table "+n.name+" has been drop"),e.all(r).then(function(){o.resolve()})}),o.promise},t.query=function(n,o){o="undefined"!=typeof o?o:[];var r=e.defer();return t.db.transaction(function(e){e.executeSql(n,o,function(e,n){r.resolve(n)},function(e,n){console.log("Database Error:"+n.message),r.reject(n)})}),r.promise},t.fetchAll=function(e){for(var n=[],t=0;t<e.rows.length;t++)n.push(e.rows.item(t));return n},t.fetch=function(e){return e.rows.item(0)},t}]),brfPhoneGapApp.factory("Login",["$http","Database",function(e,n){var t=this;return t.validateUser=function(n,t){return e.get("http://ws.brf-horizonte.com/validate/user/?token=560a100abad225d5afdf4fc6e5334917&email="+n+"&pass="+t)},t.authenticated=function(){return void 0!=BrfNameSpace.Session.getInstance().get()},t.authenticate=function(e){BrfNameSpace.Session.getInstance().set(e)},t.getToken=function(e){return BrfNameSpace.Session.getInstance().get()},t}]),brfPhoneGapApp.factory("Module",["$http","Database",function(e,n){var t=this;return t.synchronizeModules=function(){return e.get("http://ws.brf-horizonte.com/get/modules/?token=560a100abad225d5afdf4fc6e5334917")},t.setModule=function(e,t,o,r,a,i,u){n.query("INSERT INTO Module(moduleId, behavior, modName, categoryType, color, icon, slug) VALUES(?, ?, ?, ?, ?, ?, ?)",[e,t,o,r,a,i,u]).then(function(e){return!0})},t.setModuleChannels=function(e,t){n.query("INSERT INTO ModuleChannels(moduleId, channelId) VALUES(?, ?)",[e,t]).then(function(e){return!0})},t.setModuleRoles=function(e,t){n.query("INSERT INTO ModuleUserRoles(moduleId, roleId) VALUES(?, ?)",[e,t]).then(function(e){return!0})},t.getModuleByName=function(e){return n.query("SELECT id, moduleId, behavior, modName, categoryType, color, icon FROM Module WHERE modName = ?",[e]).then(function(e){return n.fetch(e)})},t.getModuleBySlug=function(e){return n.query("SELECT id, moduleId, behavior, modName, categoryType, color, icon, slug FROM Module WHERE slug = ?",[e]).then(function(e){return n.fetch(e)})},t.getModules=function(e,t){var o="SELECT DISTINCT mod.id, mod.moduleId, mod.behavior, mod.modName, mod.categoryType, mod.color, mod.icon, mod.slug FROM Module mod INNER JOIN ModuleChannels modcha ON modcha.moduleId = mod.moduleId INNER JOIN ModuleUserRoles modur ON modur.moduleId = mod.moduleId WHERE modcha.channelId = ? AND modur.roleId = ?";return n.query(o,[e,t]).then(function(e){return n.fetchAll(e)})},t.getDefaultModules=function(e,t){var o="SELECT DISTINCT mod.id, mod.moduleId, mod.behavior, mod.modName, mod.categoryType, mod.color, mod.icon, mod.slug FROM Module mod INNER JOIN ModuleChannels modcha ON modcha.moduleId = mod.moduleId INNER JOIN ModuleUserRoles modur ON modur.moduleId = mod.moduleId WHERE modcha.channelId = ? AND modur.roleId = ? LIMIT 0,1";return n.query(o,[e,t]).then(function(e){return n.fetch(e)})},t.getModuleById=function(e){return n.query("SELECT * FROM Module WHERE moduleId = ?",[e]).then(function(e){return n.fetch(e)})},t}]),brfPhoneGapApp.factory("Question",["$http","Database",function(e,n){var t=this;return t.synchronizeQuestions=function(){return e.get("http://ws.brf-horizonte.com/get/questions/?token=560a100abad225d5afdf4fc6e5334917")},t.setQuestion=function(e){return n.query("INSERT INTO Question(questionId, categoryId, render, answer, title, data, helper, big, thumb, questionModuleId, config, styling) VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)",[e.questionId,e.categoryId,e.render,e.answer,e.title,e.data,e.helper,e.big,e.thumb,e.questionModuleId,e.config,e.styling]).then(function(e){return!0})},t.setQuestionPdv=function(e,t){return n.query("INSERT INTO QuestionPdv(questionId, pdvId) VALUES(?, ?)",[e,t]).then(function(e){return!0})},t.getQuestions=function(e,t,o,r){var a;return a=0===r?"SELECT q.questionId, q.render, q.answer, q.title, q.data, q.helper, q.config, q.styling, res.JSONData FROM Question q LEFT JOIN SurveyQuestionsResults res ON res.questionId = q.questionId AND res.surveyId = ? INNER JOIN Module mod ON mod.moduleId = q.questionModuleId WHERE q.questionModuleId = ?":"SELECT q.questionId, q.render, q.answer, q.title, q.data, q.helper, q.config, q.styling, res.JSONData FROM Question q LEFT JOIN SurveyQuestionsResults res ON res.questionId = q.questionId AND res.surveyId = ? INNER JOIN Module mod ON mod.moduleId = q.questionModuleId INNER JOIN Category cat ON cat.categoryId = q.categoryId AND cat.type = mod.categoryType WHERE q.questionModuleId = ?",void 0!==o&&null!==o&&0!=o&&(a=a+" AND q.categoryId = "+o),n.query(a,[t,e]).then(function(e){for(var n=[],t=function(e,n){var t;if(null===e)switch(n){case"binary":t={};break;case"open":t={value:""};break;case"price":t={value:""};break;case"multiple":t=[]}else"multiple"!==n&&(t=JSON.parse(e));return t},o=function(e,n,t){return null===e?t:"multiple"!==n?t:(t.answer_config.selected=JSON.parse(e),t)},r=0;r<e.rows.length;r++)n.push({id:e.rows.item(r).questionId,render:e.rows.item(r).render,answer:e.rows.item(r).answer,title:e.rows.item(r).title,data:e.rows.item(r).data,helper:e.rows.item(r).helper,config:o(e.rows.item(r).JSONData,e.rows.item(r).answer,JSON.parse(e.rows.item(r).config)),styling:JSON.parse(e.rows.item(r).styling),JSONData:t(e.rows.item(r).JSONData,e.rows.item(r).answer)});return n})},t}]),brfPhoneGapApp.factory("Seller",["$http","Database",function(e,n){var t=this;return t.synchronizeSellers=function(){return e.get("http://ws.brf-horizonte.com/get/sellers/?token=560a100abad225d5afdf4fc6e5334917")},t.setSeller=function(e,t){return n.query("INSERT INTO Seller(id, name) VALUES(?, ?)",[e,t]).then(function(e){return!0})},t.getSellers=function(){return n.query("SELECT id, name FROM Seller").then(function(e){return n.fetchAll(e)})},t.setChoosenPdv=function(e){window.localStorage.setItem(pdvKeyId,e)},t}]);var auditModeKey="audit-mode",channelKeyId="channel-id",pdvKeyId="pdv-id",sellerKeyId="seller-id";brfPhoneGapApp.factory("Survey",["$http","Database",function(e,n){var t=this;return t.setSurvey=function(e){return n.query("INSERT INTO Survey(survey, syncStatus) VALUES (?, ?)",[e,0]).then(function(e){return!0})},t.getPendingSurvey=function(){return n.query("SELECT id, survey, syncStatus FROM Survey WHERE syncStatus = 0 LIMIT 0,1").then(function(e){return e.rows.length>0?n.fetch(e):void 0})},t.closeSurvey=function(){return n.query("UPDATE Survey SET syncStatus = 1 WHERE syncStatus = 0").then(function(e){return!0})},t.enableAuditMode=function(e,n,t){window.localStorage.setItem(auditModeKey,!0),window.localStorage.setItem(channelKeyId,e),window.localStorage.setItem(pdvKeyId,n),window.localStorage.setItem(sellerKeyId,t)},t.disableAuditMode=function(){window.localStorage.setItem(auditModeKey,!1),window.localStorage.setItem(channelKeyId,0),window.localStorage.setItem(pdvKeyId,0),window.localStorage.setItem(sellerKeyId,0)},t.getAuditMode=function(){return void 0===window.localStorage.getItem(auditModeKey)&&window.localStorage.setItem(auditModeKey,!1),"true"===window.localStorage.getItem(auditModeKey)},t.getAuditChannel=function(){return void 0===window.localStorage.getItem(channelKeyId)&&window.localStorage.setItem(channelKeyId,0),window.localStorage.getItem(channelKeyId)},t.getAuditPdv=function(){return void 0===window.localStorage.getItem(pdvKeyId)&&window.localStorage.setItem(pdvKeyId,0),window.localStorage.getItem(pdvKeyId)},t.getAuditSeller=function(){return void 0===window.localStorage.getItem(sellerKeyId)&&window.localStorage.setItem(sellerKeyId,0),window.localStorage.getItem(sellerKeyId)},t.setQuestionAnswer=function(e,t,o){return n.query("UPDATE SurveyQuestionsResults SET JSONData = ? WHERE questionId = ? AND surveyId = ?",[o,t,e]).then(function(r){return 0===r.rowsAffected?n.query("INSERT INTO SurveyQuestionsResults(surveyId, questionId, JSONData) VALUES (?, ?, ?)",[e,t,o]).then(function(e){return!0}):!0})},t.deleteQuestionAnswer=function(e,t){return n.query("DELETE FROM SurveyQuestionsResults WHERE questionId = ? AND surveyId = ?",[t,e]).then(function(e){return!0})},t.setNoBrf=function(e,t){return n.query("UPDATE SurveyNoBrfResults SET noBrf = ? WHERE surveyId = ?",[t,e]).then(function(o){return 0===o.rowsAffected?n.query("INSERT INTO SurveyNoBrfResults(surveyId, noBrf) VALUES(?, ?)",[e,t]).then(function(e){return!0}):!0})},t.setObservations=function(e,t){return n.query("UPDATE SurveyObservationResults SET observations = ? WHERE surveyId = ?",[t,e]).then(function(o){return 0===o.rowsAffected?n.query("INSERT INTO SurveyObservationResults(surveyId, observations) VALUES(?, ?)",[e,t]).then(function(e){return!0}):!0})},t.getNoBrf=function(e){return n.query("SELECT noBrf FROM SurveyNoBrfResults WHERE surveyId = ?",[e]).then(function(e){return e.rows.length>0?n.fetch(e):void 0})},t.getObservations=function(e){return n.query("SELECT observations FROM SurveyObservationResults WHERE surveyId = ?",[e]).then(function(e){return e.rows.length>0?n.fetch(e):void 0})},t}]);